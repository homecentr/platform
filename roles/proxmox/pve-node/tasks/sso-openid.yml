- name: Create default domains.cfg if it does not exist
  run_once: true # Proxmox cluster 
  ansible.builtin.command:
    cmd: pveum realm modify pam --default 0

- name: Define PVE realm
  ansible.builtin.blockinfile:
    create: false
    path: /etc/pve/domains.cfg
    marker: "# {mark} ANSIBLE MANAGED BLOCK (OpenID {{ item.name }})"
    block: |
      openid: {{ item.name }}
          comment {{ item.display_name }}
          client-id {{ item.client_id }}
          client-key {{ item.client_secret }}
          issuer-url {{ item.url }}
          autocreate {{ '1' if item.autocreate_users else '0' }}
          default {{ '1' if pve_default_realm_name == item.name else '0' }}
          {% if 'username_claim' in item %}username-claim {{ item.username_claim }}{% endif %}
          
          {% if 'scopes' in item %}scopes {{ item.scopes }}{% endif %}
  with_items: "{{ pve_openid_realms }}"
