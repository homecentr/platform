- name: "Install Network UPS Tools"
  package:
    name: nut
    state: present

- name: "Check if node is hosting a ups device"
  set_fact:
    hosted_ups_devices: "{{ ups_devices | selectattr('monitored_by', 'equalto', inventory_hostname) | map(attribute='name') }}"

- include_tasks: master.yml
  when: (hosted_ups_devices | length) > 0

- name: Set facts
  set_fact:
    ups_server: "{{ (ups_devices | selectattr('name', 'equalto', ups_name) | map(attribute='monitored_by'))[0] }}"

- name: "Configure UPS Monitor mode"
  notify: restart ups_monitor
  copy:
    dest: /etc/nut/nut.conf
    force: yes
    mode: 0640
    owner: root
    group: nut
    content: |
      MODE={{ 'netserver' if (hosted_ups_devices | length) > 0 else 'netclient' }}

- name: "Configure Network UPS Tools Monitor"
  notify: restart ups_monitor
  copy:
    dest: /etc/nut/upsmon.conf
    force: yes
    mode: 0640
    owner: root
    group: nut
    content: "{{ lookup('template', 'upsmon.conf.j2') }}"

- name: "Start the ups monitor"
  service:
    name: nut-monitor
    state: started

- name: "Dump the ups name to /etc/ups"
  copy:
    dest: /etc/ups
    content: "{{ ups_name }}@{{ ups_server }}"
    owner: root
    group: root
    mode: 0644