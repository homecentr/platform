authenticate_service_url: https://{{ app_pomerium_hostname }}

autocert: false

certificates:
{% for cert in app_pomerium_certificates %}
  - cert: '{{ cert.fullchain_path }}'
    key: '{{ cert.key_path }}'
{% endfor %}

idp_provider: {{ app_pomerium_idp_provider }}
idp_provider_url: '{{ app_pomerium_idp_provider_url }}'
idp_client_id: {{ app_pomerium_idp_client_id }}
idp_client_secret: {{ app_pomerium_idp_client_secret }}

cookie_secret: {{ app_pomerium_cookie_secret }}

# TODO: metrics_address: :9090

routes:
{% for host in groups['all'] %}
{% for route in hostvars[host].app_pomerium_routes | default([]) %}
  - from: https://{{ route.hostname }}.{{ domain }}
    to: {{ route.protocol | default("http") }}://{{ hostvars[host].ansible_host }}:{{ route.target_port | default(80) }}
{% if route.auth_mode == 'administrators' %}
    policy:
      - allow:
          or:
            - claim/groups: "{{ app_pomerium_groups_administrators }}"
{% elif route.auth_mode == 'users' %}
    policy:
      - allow:
          or:
            - claim/groups: "{{ app_pomerium_groups_users }}"
{% else %}
    allow_public_unauthenticated_access: true
{% endif %}
{% endfor %}
{% endfor %}
