- name: Add jetstack helm repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: "https://charts.jetstack.io"
    state: present

- name: Deploy cert-manager
  run_once: true
  kubernetes.core.helm:
    state: present
    release_name: cert-manager
    release_namespace: cert-manager
    create_namespace: yes
    chart_version: "{{ certmanager_chart_version }}"
    chart_ref: jetstack/cert-manager
    kubeconfig_path: "{{ certmanager_kubeconfig_path }}"
    values:
      installCRDs: true
      webhook:
        securePort: "{{ certmanager_webhook_secure_port }}"
        resources:
          limits:
            cpu: "{{ certmanager_webhook_cpu_limit }}"
            memory: "{{ certmanager_webhook_memory_limit }}"
          requests:
            cpu: "{{ certmanager_webhook_cpu_request }}"
            memory: "{{ certmanager_webhook_memory_request }}"
        containerSecurityContext:
          allowPrivilegeEscalation: false
          privileged: false
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 2000
          readOnlyRootFilesystem: true
          capabilities:
              drop:
              - all
      cainjector:
        resources:
          limits:
            cpu: "{{ certmanager_cainjector_cpu_limit }}"
            memory: "{{ certmanager_cainjector_memory_limit }}"
          requests:
            cpu: "{{ certmanager_cainjector_cpu_request }}"
            memory: "{{ certmanager_cainjector_memory_request }}"
        containerSecurityContext:
          allowPrivilegeEscalation: false
          privileged: false
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 2000
          readOnlyRootFilesystem: true
          capabilities:
              drop:
              - all
      resources:
        limits:
          cpu: "{{ certmanager_cpu_limit }}"
          memory: "{{ certmanager_memory_limit }}"
        requests:
          cpu: "{{ certmanager_cpu_request }}"
          memory: "{{ certmanager_memory_request }}"
      containerSecurityContext:
        allowPrivilegeEscalation: false
        privileged: false
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 2000
        readOnlyRootFilesystem: true
        capabilities:
            drop:
            - all